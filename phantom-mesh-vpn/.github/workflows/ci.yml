name: PhantomMesh CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
    rust-build:
        name: Rust Build & Test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-action@stable
              with:
                  components: clippy, rustfmt

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Check formatting
              run: cargo fmt --all -- --check

            - name: Clippy lints
              run: cargo clippy --all-targets --all-features -- -D warnings

            - name: Run tests
              run: cargo test --all-features --no-fail-fast

            - name: Build release
              run: cargo build --release

    python-test:
        name: Python Agent Tests
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  pip install -e ".[dev]"

            - name: Lint with ruff
              run: ruff check src/agent_swarm

            - name: Type check with mypy
              run: mypy src/agent_swarm

            - name: Run pytest
              run: pytest tests/ -v --cov=src/agent_swarm --cov-report=xml

            - name: Upload coverage
              uses: codecov/codecov-action@v4
              with:
                  files: ./coverage.xml
                  fail_ci_if_error: true

    docker-build:
        name: Docker Build
        runs-on: ubuntu-latest
        needs: [rust-build, python-test]
        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build VPN node image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile.node
                  push: false
                  tags: phantom-mesh-vpn:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build agent image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile.agents
                  push: false
                  tags: phantom-mesh-agents:${{ github.sha }}

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Run cargo-audit
              uses: rustsec/audit-check@v1
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  severity: "CRITICAL,HIGH"
