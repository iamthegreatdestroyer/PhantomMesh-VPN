# Linkerd Service Mesh Configuration for PhantomMesh

apiVersion: v1
kind: Service
metadata:
  name: phantom-node
  namespace: phantom-mesh
  annotations:
    linkerd.io/inject: enabled
spec:
  selector:
    app: phantom-node
  ports:
    - name: api
      port: 8080
      targetPort: 8080
    - name: wireguard
      port: 51820
      targetPort: 51820
      protocol: UDP
---
apiVersion: v1
kind: Service
metadata:
  name: agent-swarm
  namespace: phantom-mesh
  annotations:
    linkerd.io/inject: enabled
spec:
  selector:
    app: agent-swarm
  ports:
    - name: metrics
      port: 8000
      targetPort: 8000
---
apiVersion: v1
kind: Service
metadata:
  name: discovery
  namespace: phantom-mesh
  annotations:
    linkerd.io/inject: enabled
spec:
  selector:
    app: discovery
  ports:
    - name: discovery-api
      port: 8081
      targetPort: 8081
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: phantom-mesh
  annotations:
    linkerd.io/inject: enabled
spec:
  selector:
    app: prometheus
  ports:
    - name: http
      port: 9090
      targetPort: 9090
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: phantom-mesh
  annotations:
    linkerd.io/inject: enabled
spec:
  selector:
    app: grafana
  ports:
    - name: http
      port: 3000
      targetPort: 3000
---
apiVersion: policy.linkerd.io/v1beta1
kind: Server
metadata:
  name: phantom-node-server
  namespace: phantom-mesh
spec:
  podSelector:
    matchLabels:
      app: phantom-node
  port: 8080
  proxyProtocol: HTTP/1
---
apiVersion: policy.linkerd.io/v1beta1
kind: ServerAuthorization
metadata:
  name: phantom-node-authz
  namespace: phantom-mesh
spec:
  server:
    selector:
      matchLabels:
        app: phantom-node
  client:
    meshTLS:
      serviceAccounts:
        - name: phantom-service-account
          namespace: phantom-mesh
---
apiVersion: policy.linkerd.io/v1beta1
kind: HTTPRoute
metadata:
  name: phantom-node-route
  namespace: phantom-mesh
spec:
  parentRefs:
    - name: phantom-node-server
      kind: Server
      group: policy.linkerd.io
  rules:
    - matches:
        - path:
            value: "/api"
          method: GET
        - path:
            value: "/health"
          method: GET
        - path:
            value: "/ready"
          method: GET
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            add:
              - name: x-phantom-mesh
                value: "true"
